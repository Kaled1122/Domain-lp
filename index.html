<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BAE Systems — Training Suite</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body {
  font-family: "Inter", sans-serif;
  background-color: #f5f6f7;
  color: #1f2937;
  line-height: 1.5;
}
header {
  text-align: center;
  margin-bottom: 2.5rem;
}
h1 {
  font-size: 2rem;
  font-weight: 700;
  color: #1e3a8a;
}
h2 {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1rem;
  color: #1e3a8a;
}
.card {
  background-color: #fff;
  border-radius: 0.75rem;
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  padding: 2rem;
  margin-bottom: 2rem;
}
nav button {
  padding: 10px 24px;
  border-radius: 6px;
  margin: 0 4px;
  font-weight: 500;
  background: #f3f4f6;
  border: 1px solid #e5e7eb;
  transition: all 0.2s;
}
nav button:hover {
  background-color: #e5e7eb;
}
.active {
  background-color: #1e3a8a !important;
  color: white !important;
  border-color: #1e3a8a;
}
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  border: 1px solid #e5e7eb;
  padding: 10px;
  text-align: center;
  font-size: 0.875rem;
}
thead th {
  background-color: #f9fafb;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
}
tr:nth-child(even) {
  background-color: #f9fafb;
}
tr:hover {
  background-color: #e0e7ff;
}
input, select {
  border: 1px solid #d1d5db;
  border-radius: 4px;
  padding: 6px 8px;
  width: 100%;
}
button {
  transition: transform 0.1s ease-in-out;
}
button:active {
  transform: scale(0.97);
}
.btn-primary {
  background-color: #1e3a8a;
  color: white;
  font-weight: 600;
}
.btn-primary:hover {
  background-color: #1d4ed8;
}
.btn-secondary {
  background-color: #374151;
  color: white;
}
.btn-secondary:hover {
  background-color: #4b5563;
}
.btn-success {
  background-color: #047857;
  color: white;
}
.btn-success:hover {
  background-color: #059669;
}
footer {
  text-align: center;
  font-size: 0.8rem;
  color: #6b7280;
  margin-top: 2rem;
}
</style>
</head>
<body class="p-6">

<header>
  <h1>BAE Systems — Training Suite</h1>
  <p class="text-gray-600 mt-1">Lesson Planning • Performance Register • Data Analytics</p>
</header>

<nav class="flex justify-center mb-8 border-b pb-3">
  <button onclick="showTab('lesson')" id="btn-lesson" class="active">Lesson Plan</button>
  <button onclick="showTab('register')" id="btn-register">Performance Register</button>
  <button onclick="showTab('dashboard')" id="btn-dashboard">Dashboard</button>
  <button onclick="showTab('average')" id="btn-average">Averages</button>
</nav>

<!-- LESSON PLAN -->
<section id="lesson" class="card">
  <h2>Lesson Plan Generator</h2>
  <form id="lessonForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <input type="text" name="teacher" placeholder="Teacher Name" />
    <input type="text" name="lesson_title" placeholder="Lesson Title" />
    <input type="text" name="duration" placeholder="Duration (e.g. 45 minutes)" />
    <input type="text" name="cefr" placeholder="CEFR Level" />
    <input type="text" name="profile" placeholder="Learner Profile" />
    <input type="file" name="file" accept=".pdf,.txt" class="col-span-2 border p-2 bg-gray-50" />
    <button type="submit" class="col-span-2 btn-primary py-2 rounded-md">
      Generate Lesson Plan
    </button>
  </form>

  <iframe id="lessonOutput" class="w-full h-[550px] border rounded-md"></iframe>

  <div class="mt-4 text-right">
    <button id="downloadLesson" class="btn-success px-5 py-2 rounded-md">Download Lesson (PDF)</button>
  </div>
</section>

<!-- REGISTER -->
<section id="register" class="card hidden">
  <h2>Performance Register</h2>
  <p class="text-gray-600 mb-4">Enter scores for up to 16 learners (0–25 per domain).</p>
  <button onclick="saveData()" class="btn-primary px-5 py-2 rounded-md mb-4">Save Records</button>

  <div class="overflow-x-auto">
    <table id="regTable">
      <thead><tr>
        <th>Learner ID</th><th>Understanding</th><th>Application</th><th>Communication</th><th>Behavior</th><th>Total</th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- DASHBOARD -->
<section id="dashboard" class="card hidden">
  <div class="flex justify-between items-center mb-4">
    <h2>Performance Dashboard</h2>
    <button onclick="downloadExcel('dataTable')" class="btn-success px-4 py-2 rounded-md">Export Excel</button>
  </div>
  <div class="overflow-x-auto">
    <table id="dataTable">
      <thead><tr><th>Learner</th><th>U</th><th>A</th><th>C</th><th>B</th><th>Total</th><th>Date</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<!-- AVERAGE -->
<section id="average" class="card hidden">
  <h2>Learner Averages</h2>
  <p class="text-gray-600 mb-3">Automatically computes averages across all entries for each learner.</p>
  <div class="overflow-x-auto">
    <table id="avgTable">
      <thead><tr><th>Learner</th><th>U</th><th>A</th><th>C</th><th>B</th><th>Average Total</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<footer>
  © 2025 BAE Systems Saudi Development & Training — Internal Use Only
</footer>

<script>
const backend = "https://domain-lp-production.up.railway.app";

function showTab(tab) {
  ["lesson","register","dashboard","average"].forEach(t=>{
    document.getElementById(t).classList.add("hidden");
    document.getElementById("btn-"+t).classList.remove("active");
  });
  document.getElementById(tab).classList.remove("hidden");
  document.getElementById("btn-"+tab).classList.add("active");
  if(tab==="register") buildTable();
  if(tab==="dashboard") loadDashboard();
  if(tab==="average") loadAverages();
}

function buildTable() {
  const tb=document.querySelector("#regTable tbody");
  tb.innerHTML="";
  for(let i=1;i<=16;i++){
    tb.innerHTML+=`<tr>
      <td><input value="" class="border p-1 w-24 text-center"></td>
      <td><input type="number" min=0 max=25 class="border p-1 w-20 text-center"></td>
      <td><input type="number" min=0 max=25 class="border p-1 w-20 text-center"></td>
      <td><input type="number" min=0 max=25 class="border p-1 w-20 text-center"></td>
      <td><input type="number" min=0 max=25 class="border p-1 w-20 text-center"></td>
      <td><input readonly class="border p-1 w-20 bg-gray-100 text-center font-semibold"></td>
    </tr>`;
  }
  document.querySelectorAll("#regTable input").forEach(i=>{
    i.oninput=()=>{
      const r=i.closest("tr").querySelectorAll("input");
      r[5].value=(+r[1].value||0)+(+r[2].value||0)+(+r[3].value||0)+(+r[4].value||0);
    };
  });
}

async function saveData(){
  const rows=[...document.querySelectorAll("#regTable tbody tr")].map(r=>{
    const c=r.querySelectorAll("input");
    return{lesson_id:"T1",learner_id:c[0].value,
    understanding:c[1].value,application:c[2].value,communication:c[3].value,
    behavior:c[4].value,total:c[5].value};
  });
  const res=await fetch(`${backend}/save_performance`,{
    method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(rows)
  });
  alert((await res.json()).message||"Saved");
}

function color(t){
  if(t>=90)return"bg-green-100";
  if(t>=75)return"bg-yellow-100";
  if(t>=60)return"bg-orange-100";
  if(t>=40)return"bg-red-100";
  return"bg-gray-100";
}

async function loadDashboard(){
  const res=await fetch(`${backend}/fetch_data`);
  const data=await res.json();
  const tb=document.querySelector("#dataTable tbody");
  tb.innerHTML="";
  data.forEach(r=>{
    tb.innerHTML+=`<tr class="${color(r.total)}">
    <td>${r.learner_id}</td><td>${r.understanding}</td><td>${r.application}</td>
    <td>${r.communication}</td><td>${r.behavior}</td><td>${r.total}</td><td>${r.timestamp}</td></tr>`;
  });
}

async function loadAverages(){
  const res=await fetch(`${backend}/fetch_averages`);
  const data=await res.json();
  const tb=document.querySelector("#avgTable tbody");
  tb.innerHTML="";
  data.forEach(r=>{
    tb.innerHTML+=`<tr class="${color(r.total)}">
    <td>${r.learner_id}</td><td>${r.understanding}</td><td>${r.application}</td>
    <td>${r.communication}</td><td>${r.behavior}</td><td>${r.total}</td></tr>`;
  });
}

function downloadExcel(id){
  let csv='';document.querySelectorAll(`#${id} tr`).forEach(r=>{
    const cols=[...r.querySelectorAll("td,th")].map(c=>c.innerText.replace(/,/g,";"));
    csv+=cols.join(",")+"\n";
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download="data.csv";a.click();
}

// LESSON PLAN
document.getElementById("lessonForm").onsubmit=async e=>{
  e.preventDefault();
  const fd=new FormData(e.target);
  const res=await fetch(`${backend}/generate_lesson`,{method:"POST",body:fd});
  const html=await res.text();
  document.getElementById("lessonOutput").srcdoc=html;
};

document.getElementById("downloadLesson").onclick=()=>{
  const frame=document.getElementById("lessonOutput").contentWindow.document;
  const blob=new Blob([frame.documentElement.outerHTML],{type:"text/html"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);a.download="lesson_plan.html";a.click();
};
</script>
</body>
</html>
